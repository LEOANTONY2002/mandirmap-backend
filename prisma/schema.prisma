// This is your optimized Mandir Map schema file
// Modified for PostGIS, Firebase Auth, and Cloudflare Media

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [postgis]
}

// --- 1. User & Profile Management ---
model User {
  id                String         @id @default(uuid())
  firebaseUid       String         @unique @map("firebase_uid") // CRITICAL for Firebase Auth
  fullName          String         @map("full_name")
  email             String?        @unique
  phoneNumber       String         @unique @map("phone_number")
  avatarUrl         String?        @map("avatar_url")
  language          Language       @default(ENGLISH)
  address1          String?        @map("address_1")
  address2          String?        @map("address_2")
  address3          String?        @map("address_3")
  fcmToken          String?        @map("fcm_token")
  createdAt         DateTime       @default(now()) @map("created_at")
  
  // Relations
  reviews           Review[]
  media             MediaContent[]
  favorites         Favorite[]
}

enum Language {
  ENGLISH
  MALAYALAM
  TAMIL
  HINDI
  TELUGU
}

// --- 2. Central Location Entity ---
model Location {
  id              String       @id @default(uuid())
  name            String
  nameMl          String?      @map("name_ml")
  category        Category
  description     String?      @db.Text
  descriptionMl   String?      @map("description_ml") @db.Text
  addressText     String       @map("address_text")
  addressTextMl   String?       @map("address_text_ml")
  latitude        Float
  longitude       Float
  
  // PostGIS point for spatial indexing
  coords          Unsupported("geography(Point, 4326)")? @map("coords")

  averageRating   Float        @default(0.0) @map("average_rating")
  totalRatings    Int          @default(0) @map("total_ratings")

  // Sub-entity relations
  temple          Temple?
  hotel           Hotel?
  restaurant      Restaurant?
  
  // Social and Event relations
  reviews         Review[]
  media           MediaContent[]
  favoritedBy     Favorite[]
  festivals       Festival[]   

  @@index([coords], name: "location_coords_idx", type: Gist)
}

enum Category {
  TEMPLE
  RESTAURANT
  HOTEL
  TRAVEL_HUB
  POOJARI
  SHOP
}

// --- 3. Deities & Temple Domain ---
model Deity {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  nameMl      String?  @map("name_ml")
  photoUrl    String?  @map("photo_url")
  
  temples     TempleDeity[]
  festivals   Festival[]
}

model TempleDeity {
  templeId    String   @map("temple_id")
  deityId     Int      @map("deity_id")
  temple      Temple   @relation(fields: [templeId], references: [locationId])
  deity       Deity    @relation(fields: [deityId], references: [id])

  @@id([templeId, deityId])
}

model Temple {
  locationId      String   @id @map("location_id")
  location        Location @relation(fields: [locationId], references: [id], onDelete: Cascade)
  history         String?  @db.Text
  historyMl       String?  @map("history_ml") @db.Text
  openTime        String?  @map("open_time")
  closeTime       String?  @map("close_time")
  vazhipaduData   Json?    @map("vazhipadu_details") 

  deities         TempleDeity[]
}

// --- 4. Festivals ---
model Festival {
  id              String   @id @default(uuid())
  name            String
  nameMl          String?  @map("name_ml")
  description     String?  @db.Text
  descriptionMl   String?  @map("description_ml") @db.Text
  startDate       DateTime @map("start_date")
  endDate         DateTime @map("end_date")
  
  locationId      String   @map("location_id")
  location        Location @relation(fields: [locationId], references: [id])
  
  deityId         Int?     @map("deity_id")
  deity           Deity?   @relation(fields: [deityId], references: [id])
  
  photoUrl        String?  @map("photo_url")
}

// --- 5. Accommodations & Services ---
model Hotel {
  locationId      String   @id @map("location_id")
  location        Location @relation(fields: [locationId], references: [id], onDelete: Cascade)
  pricePerDay     Decimal  @map("price_per_day") @db.Decimal(10, 2)
  contactPhone    String?  @map("contact_phone")
  whatsapp        String?
  amenities       Json?    
}

model Restaurant {
  locationId      String   @id @map("location_id")
  location        Location @relation(fields: [locationId], references: [id], onDelete: Cascade)
  isPureVeg       Boolean  @default(true) @map("is_pure_veg")
  menuItems       Json?    @map("menu_items")
}

// --- 6. Astrology ---
model Astrologer {
  id              String   @id @default(uuid())
  name            String
  experienceYears Int      @map("experience_years")
  languages       String[]
  hourlyRate      Decimal  @map("hourly_rate") @db.Decimal(10, 2)
  bio             String?  @db.Text
  rating          Float    @default(0.0)
  latitude        Float
  longitude       Float
  coords          Unsupported("geography(Point, 4326)")? @map("coords")

  @@index([coords], name: "astrologer_coords_idx", type: Gist)
}

// --- 7. Social Content (Reels & Reviews) ---
model MediaContent {
  id            String    @id @default(uuid())
  uploaderId    String    @map("user_id")
  user          User      @relation(fields: [uploaderId], references: [id])
  locationId    String?   @map("location_id")
  location      Location? @relation(fields: [locationId], references: [id])
  url           String    
  thumbnailUrl  String?   @map("thumbnail_url")
  type          MediaType 
  likes         Int       @default(0)
  createdAt     DateTime  @default(now()) @map("created_at")
}

enum MediaType {
  IMAGE
  VIDEO
}

model Review {
  id            String   @id @default(uuid())
  userId        String   @map("user_id")
  user          User     @relation(fields: [userId], references: [id])
  locationId    String   @map("location_id")
  location      Location @relation(fields: [locationId], references: [id], onDelete: Cascade)
  rating        Int
  comment       String?  @db.Text
  createdAt     DateTime @default(now()) @map("created_at")
}

model Favorite {
  id            String   @id @default(uuid())
  userId        String   @map("user_id")
  user          User     @relation(fields: [userId], references: [id])
  locationId    String   @map("location_id")
  location      Location @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@unique([userId, locationId])
}
